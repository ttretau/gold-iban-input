<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">

<script src="iban-validator.js"></script>

<dom-module id="gold-iban-input">
  <template>
    <style>
      :host {
        display: block;
      }

      .container {
        @apply --layout-horizontal;
      }

      input {
        @apply --layout-flex;
      }

      input {
        position: relative; /* to make a stacking context */
        outline: none;
        box-shadow: none;
        padding: 0;
        width: 100%;
        max-width: 100%;
        background: transparent;
        border: none;
        color: var(--paper-input-container-input-color, var(--primary-text-color));
        -webkit-appearance: none;
        text-align: inherit;
        vertical-align: bottom;
        /* Firefox sets a min-width on the input, which can cause layout issues */
        min-width: 0;
        @apply --paper-font-subhead;
        @apply --paper-input-container-input;
      }
      input::-webkit-input-placeholder {
        color: var(--paper-input-container-color, var(--secondary-text-color));
      }
      input:-moz-placeholder {
        color: var(--paper-input-container-color, var(--secondary-text-color));
      }
      input::-moz-placeholder {
        color: var(--paper-input-container-color, var(--secondary-text-color));
      }
      input:-ms-input-placeholder {
        color: var(--paper-input-container-color, var(--secondary-text-color));
      }
    </style>
    <paper-input-container id="container"
                           disabled$="[[disabled]]"
                           no-label-float="[[noLabelFloat]]"
                           always-float-label="[[_computeAlwaysFloatLabel(alwaysFloatLabel,placeholder)]]"
                           invalid="[[invalid]]">

      <label slot="label" hidden$="[[!label]]">[[label]]</label>

      <span id="template-placeholder"></span>

      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error slot="add-on" id="error">
          [[errorMessage]]
        </paper-input-error>
      </template>

    </paper-input-container>
  </template>

  <template id="v0">
    <div class="container">
      <input is="iron-input" id="input" slot="input"
             aria-labelledby$="[[_ariaLabelledBy]]"
             aria-describedby$="[[_ariaDescribedBy]]"
             bind-value="{{value}}"
             type="text"
             maxlength="31"
             spellcheck="false"
             required$="[[required]]"
             allowed-pattern="[a-zA-Z0-9 ]"
             prevent-invalid-input
             autocomplete="cc-number"
             name$="[[name]]"
             disabled$="[[disabled]]"
             invalid="{{invalid}}"
             autofocus$="[[autofocus]]"
             inputmode$="[[inputmode]]"
             placeholder$="[[placeholder]]"
             readonly$="[[readonly]]"
             size$="[[size]]">
    </div>
  </template>

  <template id="v1">
    <iron-input id="input" slot="input"
                allowed-pattern="[a-zA-Z0-9 ]"
                bind-value="{{value}}"
                invalid="{{invalid}}"
                maxlength="31">
      <input id="nativeInput"
             aria-labelledby$="[[_ariaLabelledBy]]"
             aria-describedby$="[[_ariaDescribedBy]]"
             invalid$="{{invalid}}"
             required$="[[required]]"
             type="text"
             prevent-invalid-input
             spellcheck="false"
             autocomplete="cc-number"
             name$="[[name]]"
             disabled$="[[disabled]]"
             autofocus$="[[autofocus]]"
             inputmode$="[[inputmode]]"
             placeholder$="[[placeholder]]"
             readonly$="[[readonly]]"
             size$="[[size]]">
    </iron-input>
  </template>

  <script>
    /**
     * `gold-iban-input`
     * Material Design IBAN Input Element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    (function() {
        Polymer({

            is: 'gold-iban-input',

            behaviors: [
                Polymer.PaperInputBehavior,
                Polymer.IronValidatableBehavior,
                Polymer.IronFormElementBehavior
            ],

            properties: {
                /**
                 * The label for this input.
                 */
                label: {
                    type: String,
                    value: "IBAN"
                },

                value: {
                    type: String,
                    observer: '_onValueChanged',
                },
            },

            observers: [
                '_onFocusedChanged(focused)'
            ],

            ready: function() {
                if (!this.value && Polymer.Element) {
                    this.value = '';
                }

                if (this.value && !Polymer.Element) {
                    this._handleAutoValidate();
                }
            },

            beforeRegister: function() {
                this._beforeRegister();
            },

            _beforeRegister: function() {
                var template = Polymer.DomModule.import('gold-iban-input', 'template');
                var version = Polymer.Element ? 'v1' : 'v0';
                var inputTemplate = Polymer.DomModule.import('gold-iban-input', 'template#' + version);
                var inputPlaceholder = template.content.querySelector('#template-placeholder');
                inputPlaceholder.parentNode.replaceChild(inputTemplate.content, inputPlaceholder);
            },
            /**
             * Returns a reference to the focusable element. Overridden from PaperInputBehavior
             * to correctly focus the native input.
             */
            get _focusableElement() {
                return Polymer.Element ? this.inputElement._inputElement : this.inputElement;
            },
            // Note: This event is only available in the 1.0 version of this element.
            // In 2.0, the functionality of `_onIronInputReady` is done in
            // PaperInputBehavior::attached.
            listeners: {
                'iron-input-ready': '_onIronInputReady'
            },
            _onIronInputReady: function() {
                // Only validate when attached if the input already has a value.
                if (!!this.inputElement.bindValue) {
                    this._handleAutoValidate();
                }
            },

            /**
             * A handler that is called on input
             */
            _onValueChanged: function(value, oldValue) {
                if (oldValue == undefined)
                    return;

                var start = this.$.input.selectionStart;
                var previousCharASpace = value ? this.value.charAt(start - 1) == ' ' : false;

                value = value.replace(/\s+/g, '');
                var formattedValue = '';
                for (var i = 0; i < value.length; i++) {
                    // Add a space after every 4 characters.
                    if ((i != 0) && (i % 4 == 0)) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                this.updateValueAndPreserveCaret(formattedValue.trim());

                // If the character right before the selection is a newly inserted
                // space, we need to advance the selection to maintain the caret position.
                if (!previousCharASpace && this.value.charAt(start - 1) == ' ') {
                    this.$.input.selectionStart = start+1;
                    this.$.input.selectionEnd = start+1;
                }

                this._handleAutoValidate();
            },

            /**
             * Returns true if the element has a valid value, and sets the visual
             * error state.
             *
             * @return {boolean} Whether the input is currently valid or not.
             */
            validate: function() {
                // Empty, non-required input is valid.
                if (!this.required && this.value == '') {
                    return true;
                }

                var result = IBANValidator.validate(this.value);
                var valid = result.valid && result.syntax_valid;

                // Update the container and its addons (i.e. the custom error-message).
                this.$.container.invalid = !valid;

                this.$.container.updateAddons({
                    inputElement: this.$.input,
                    value: this.value,
                    invalid: !valid
                });

                return valid;
            },

            /**
             * Overidden from Polymer.IronControlState.
             */
            _onFocusedChanged: function(focused) {
                if (!this._focusableElement) {
                    return;
                }
                if (!focused) {
                    this._handleAutoValidate();
                }
            },
        })

    })();

  </script>
</dom-module>
